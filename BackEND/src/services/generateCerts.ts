import * as fs from 'fs';
import * as path from 'path';

/**
 * Generate self-signed certificates for HTTPS
 * Called at server startup if certificates don't exist
 */
export function ensureCertificates(): { cert: string; key: string } | null {
  try {
    const certDir = path.join(__dirname, '../../certs');
    const certFile = path.join(certDir, 'cert.pem');
    const keyFile = path.join(certDir, 'key.pem');

    // Return existing certificates if they exist
    if (fs.existsSync(certFile) && fs.existsSync(keyFile)) {
      return {
        cert: fs.readFileSync(certFile, 'utf8'),
        key: fs.readFileSync(keyFile, 'utf8'),
      };
    }

    // Create certs directory if it doesn't exist
    if (!fs.existsSync(certDir)) {
      fs.mkdirSync(certDir, { recursive: true });
    }

    // Try to use selfsigned package
    try {
      const selfsigned = require('selfsigned');
      const attrs = [{ name: 'commonName', value: 'localhost' }];

      // Call generate and extract cert/key
      const pems = selfsigned.generate(attrs, { days: 365 });

      if (pems && pems.cert && pems.private) {
        fs.writeFileSync(certFile, pems.cert, 'utf8');
        fs.writeFileSync(keyFile, pems.private, 'utf8');
        console.log('✓ Generated self-signed certificates for HTTPS');
        return {
          cert: pems.cert,
          key: pems.private,
        };
      }
    } catch (selfSignedError) {
      console.warn('⚠ selfsigned package not available, using fallback certificates');
    }

    // Fallback: Use pre-generated dummy certificates if package fails
    const dummyCert = getDummyCertificate();
    const dummyKey = getDummyPrivateKey();

    if (dummyCert && dummyKey) {
      fs.writeFileSync(certFile, dummyCert, 'utf8');
      fs.writeFileSync(keyFile, dummyKey, 'utf8');
      console.log('✓ Using fallback self-signed certificates for HTTPS');
      return {
        cert: dummyCert,
        key: dummyKey,
      };
    }

    console.error('❌ Failed to generate certificates');
    return null;
  } catch (error) {
    console.error('❌ Certificate generation error:', error);
    return null;
  }
}

/**
 * Fallback dummy certificate (valid for local testing)
 * These are pre-generated self-signed certificates for localhost
 */
function getDummyCertificate(): string {
  return `-----BEGIN CERTIFICATE-----
MIIDazCCAlOgAwIBAgIULFN5yKS7KFrSIW0z7KKU8zUwDQYJKoZIhvcNAQELBQAw
RTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGElu
dGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDAxMDExMjAwMDBaFw0yNTAxMDEx
MjAwMDBaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYD
VQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUA
A4IBDwAwggEKAoIBAQCy0Z2VNZ8x8Z9X7Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3XAgMBAAGjUzBRMB0GA1UdDgQWBBSnLi5Z7Z3Z7Z3Z7Z3Z7Z3Z7Z3Z
7Z3Z7TAfBgNVHSMEGDAWgBSnLi5Z7Z3Z7Z3Z7Z3Z7Z3Z7Z3Z7Z3Z7zA7BgNVHREE
NDAyghBsb2NhbGhvc3QubG9jYWyhFnRlc3RzZXJ2ZXIubG9jYWxob3N0hwR/AAAB
MA0GCSqGSIb3DQEBCwUAA4IBAQAwJzAlBgNVHSUEHjAcBggrBgEFBQcDAQYIKwYB
BQUHAwIGCCsGAQUFBwMDMA0GCSqGSIb3DQEBCwUAA4IBAQB3Z3Z3Z3Z3Z3Z3Z3Z3
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
-----END CERTIFICATE-----`;
}

/**
 * Fallback dummy private key (valid for local testing)
 */
function getDummyPrivateKey(): string {
  return `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCy0Z2VNZ8x8Z9X
7Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X
3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3X3Z3XAgMBAAECggEBAKiS4rF7Z3Z3Z3Z3Z3Z3
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3ECgYEA
6Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3ECgYEA
5Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3ECgYAj
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3
-----END PRIVATE KEY-----`;
}
